cd ~/Sai-trading-bot-automation

cat > trading-bot/Jenkinsfile << 'EOF'
pipeline {
    agent any

    environment {
        DOCKER_REGISTRY = "docker.io"
        DOCKER_REPO = "asaikale"
        IMAGE_NAME = "trading-bot"
        IMAGE_TAG = "${BUILD_NUMBER}"
        KUBECONFIG = "/root/.kube/config"
    }

    stages {
        stage('Checkout') {
            steps {
                echo 'ðŸ”„ Checking out trading-bot code...'
                checkout scm
            }
        }

        stage('Install Dependencies') {
            steps {
                echo 'ðŸ“¦ Installing Python dependencies...'
                sh '''
                    cd trading-bot
                    python3 -m pip install --upgrade pip --break-system-packages
                    pip3 install -r requirements.txt --break-system-packages
                    pip3 install pytest pytest-cov --break-system-packages
                '''
            }
        }

        stage('Tests') {
            steps {
                echo 'ðŸ§ª Running pytest tests...'
                sh '''
                    cd trading-bot
                    if [ -d "tests" ]; then
                        python3 -m pytest tests/ -v --tb=short --cov=src || echo "Tests not fully configured yet"
                    else
                        echo "âš ï¸  No tests directory found. Skipping tests."
                    fi
                '''
            }
        }

        stage('SonarQube Analysis') {
            steps {
                echo 'ðŸ” Running SonarQube analysis...'
                withSonarQubeEnv('sonarqube') {
                    sh '''
                        cd trading-bot
                        sonar-scanner \
                            -Dsonar.projectKey=trading-bot \
                            -Dsonar.sources=src \
                            -Dsonar.host.url=$SONAR_HOST_URL \
                            -Dsonar.login=$SONAR_AUTH_TOKEN
                    '''
                }
            }
        }

        stage('Build') {
            steps {
                echo 'ðŸ—ï¸  Building Docker image...'
                sh '''
                    cd trading-bot
                    docker build -t ${DOCKER_REPO}/${IMAGE_NAME}:${IMAGE_TAG} .
                    docker tag ${DOCKER_REPO}/${IMAGE_NAME}:${IMAGE_TAG} ${DOCKER_REPO}/${IMAGE_NAME}:latest
                '''
            }
        }

        stage('Trivy Scan') {
            steps {
                echo 'ðŸ”’ Running Trivy security scan...'
                sh '''
                    trivy image --severity HIGH,CRITICAL \
                        ${DOCKER_REPO}/${IMAGE_NAME}:${IMAGE_TAG} || true
                '''
            }
        }

        stage('Push to Docker Hub') {
            steps {
                echo 'ðŸ“¤ Pushing image to Docker Hub...'
                withCredentials([usernamePassword(credentialsId: 'docker-hub-credentials', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
                    sh '''
                        echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
                        docker push ${DOCKER_REPO}/${IMAGE_NAME}:${IMAGE_TAG}
                        docker push ${DOCKER_REPO}/${IMAGE_NAME}:latest
                        docker logout
                    '''
                }
            }
        }

        stage('Load to Minikube') {
            steps {
                echo 'âš™ï¸  Loading image to Minikube...'
                sh '''
                    minikube image load ${DOCKER_REPO}/${IMAGE_NAME}:${IMAGE_TAG} || echo "Minikube not available, skipping local load"
                '''
            }
        }

        stage('Deploy to Kubernetes') {
            steps {
                echo 'ðŸš€ Deploying to Kubernetes (FULLY AUTOMATED FROM JENKINS)...'
                
                withCredentials([file(credentialsId: 'trading-bot-secret-file', variable: 'SECRET_FILE')]) {
                    sh '''
                        cd trading-bot/k8s
                        
                        echo "ðŸ“‹ Step 1: Applying ConfigMap..."
                        kubectl apply -f configmap.yaml
                        
                        echo "ðŸ” Step 2: Applying Secret (from Jenkins Credentials)..."
                        kubectl apply -f $SECRET_FILE
                        
                        echo "ðŸ³ Step 3: Applying Deployment..."
                        kubectl apply -f deployment.yaml
                        
                        echo "ðŸŒ Step 4: Applying Service..."
                        kubectl apply -f service.yaml
                        
                        echo "â³ Step 5: Updating image to new version..."
                        kubectl set image deployment/trading-bot \
                            trading-bot=${DOCKER_REPO}/${IMAGE_NAME}:${IMAGE_TAG} \
                            --record
                        
                        echo "â³ Step 6: Waiting for deployment to be ready..."
                        kubectl rollout status deployment/trading-bot --timeout=5m
                        
                        echo "âœ… Trading Bot Deployment Complete!"
                        echo "========================================="
                        kubectl get deployments trading-bot
                        echo ""
                        kubectl get pods -l app=trading-bot
                        echo ""
                        kubectl get svc trading-bot-service
                        echo "========================================="
                    '''
                }
            }
        }
    }

    post {
        success {
            echo 'âœ… Pipeline completed successfully!'
            echo "ðŸ³ Docker Image: ${DOCKER_REPO}/${IMAGE_NAME}:${IMAGE_TAG}"
            echo "ðŸ³ Latest Tag: ${DOCKER_REPO}/${IMAGE_NAME}:latest"
            echo "ðŸš€ Trading Bot deployed to Kubernetes!"
        }
        failure {
            echo 'âŒ Pipeline failed! Check logs above.'
        }
        always {
            echo 'ðŸ“Š Pipeline execution finished.'
        }
    }
}
EOF

# Verify it was updated
cat trading-bot/Jenkinsfile | grep -A 5 "Install Dependencies"

# Push to GitHub
git add trading-bot/Jenkinsfile
git commit -m "Fix: Add --break-system-packages for Python 3.12+ compatibility"
git push origin main

# Verify
git log --oneline -3
