pipeline {
    agent any
    
    environment {
        SONAR_HOST_URL = 'http://localhost:9000'
        DOCKER_REGISTRY = 'asaikale'
        DOCKER_IMAGE = 'webhook-server'
        DOCKER_TAG = 'latest'
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'üîÑ Checking out code from GitHub...'
                checkout scm
            }
        }
        
        stage('Tests') {
            steps {
                echo 'üß™ Running tests...'
                sh '''
                    cd webhook-server
                    npm install
                    npm test
                '''
            }
        }
        
        stage('SonarQube Analysis') {
            steps {
                echo 'üîç Running SonarQube analysis with coverage...'
                withSonarQubeEnv('sonarqube') {
                    sh '''
                        cd webhook-server
                        npm install
                        npm test
                        sonar-scanner \
                          -Dsonar.projectKey=webhook-server \
                          -Dsonar.sources=src \
                          -Dsonar.tests=tests \
                          -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info \
                          -Dsonar.host.url=$SONAR_HOST_URL \
                          -Dsonar.login=$SONAR_AUTH_TOKEN
                    '''
                }
            }
        }
        
        stage('Build') {
            steps {
                echo 'üê≥ Building Docker image...'
                sh '''
                    cd webhook-server
                    docker build -t ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:${DOCKER_TAG} .
                '''
            }
        }
        
        stage('Trivy Scan') {
            steps {
                echo 'üîê Scanning Docker image with Trivy...'
                sh '''
                    trivy image --severity HIGH,CRITICAL ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:${DOCKER_TAG}
                '''
            }
        }
        
        stage('Push to Docker Hub') {
            steps {
                echo 'üì§ Pushing Docker image to Docker Hub...'
                withCredentials([usernamePassword(credentialsId: 'dockerhub-credentials', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
                    sh '''
                        echo ${DOCKER_PASS} | docker login -u ${DOCKER_USER} --password-stdin
                        docker push ${DOCKER_REGISTRY}/${DOCKER_IMAGE}:${DOCKER_TAG}
                        docker logout
                    '''
                }
            }
        }
        
        stage('Deploy to Kubernetes') {
            steps {
                echo 'üöÄ Deploying to Kubernetes...'
                withCredentials([
                    string(credentialsId: 'DISCORD_WEBHOOK_URL', variable: 'DISCORD_URL'),
                    string(credentialsId: 'TRADING_BOT_URL', variable: 'BOT_URL')
                ]) {
                    sh '''
                        cd webhook-server
                        
                        # Delete old secret if exists
                        kubectl delete secret webhook-server-secrets --ignore-not-found
                        
                        # Create secret dynamically from Jenkins credentials
                        kubectl create secret generic webhook-server-secrets \
                          --from-literal=DISCORD_WEBHOOK_URL="${DISCORD_URL}" \
                          --from-literal=TRADING_BOT_URL="${BOT_URL}"
                        
                        # Apply other manifests
                        kubectl apply -f k8s/configmap.yaml
                        kubectl apply -f k8s/deployment.yaml
                        kubectl apply -f k8s/service.yaml
                        kubectl rollout status deployment/webhook-server
                    '''
                }
            }
        }
    }
    
    post {
        always {
            echo '‚úÖ Pipeline execution completed'
        }
        success {
            echo 'üéâ Pipeline succeeded!'
        }
        failure {
            echo '‚ùå Pipeline failed!'
        }
    }
}
